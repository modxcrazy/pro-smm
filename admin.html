<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | SMM Panel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href="css/admin.css" rel="stylesheet">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar (same as index.html) -->
    <div class="sidebar">
      <!-- Copy sidebar from index.html -->
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <header>
        <div class="header-left">
          <h3>Admin Dashboard</h3>
        </div>
        <div class="header-right">
          <div class="user-profile">
            <img id="userAvatar" src="assets/default-avatar.jpg" alt="User">
            <span id="userName">Loading...</span>
          </div>
        </div>
      </header>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="users">Users</button>
        <button class="tab-btn" data-tab="services">Services</button>
        <button class="tab-btn" data-tab="orders">Orders</button>
        <button class="tab-btn" data-tab="transactions">Transactions</button>
        <button class="tab-btn" data-tab="settings">Settings</button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Admin Dashboard Tab -->
        <div id="dashboard-tab" class="tab-pane active">
          <div class="admin-stats">
            <div class="stat-card">
              <div class="stat-icon bg-primary">
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalUsers">0</h3>
                <p>Total Users</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon bg-success">
                <i class="fas fa-cubes"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalServices">0</h3>
                <p>Active Services</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon bg-warning">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalOrders">0</h3>
                <p>Today's Orders</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon bg-danger">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalRevenue">$0.00</h3>
                <p>Today's Revenue</p>
              </div>
            </div>
          </div>

          <div class="admin-charts">
            <div class="chart-container">
              <h4>Orders Last 7 Days</h4>
              <canvas id="ordersChart"></canvas>
            </div>
            <div class="chart-container">
              <h4>Revenue Last 7 Days</h4>
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Users Management Tab -->
        <div id="users-tab" class="tab-pane">
          <div class="table-actions">
            <div class="search-box">
              <input type="text" id="userSearch" placeholder="Search users...">
              <i class="fas fa-search"></i>
            </div>
            <button id="addUserBtn" class="btn btn-primary">
              <i class="fas fa-plus"></i> Add User
            </button>
          </div>
          <div class="table-responsive">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Email</th>
                  <th>Name</th>
                  <th>Balance</th>
                  <th>Role</th>
                  <th>Joined</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Users will be loaded here -->
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <button id="prevUserPage" class="btn btn-outline" disabled>Previous</button>
            <span id="userPageInfo">Page 1 of 1</span>
            <button id="nextUserPage" class="btn btn-outline" disabled>Next</button>
          </div>
        </div>

        <!-- Services Management Tab -->
        <div id="services-tab" class="tab-pane">
          <div class="table-actions">
            <div class="search-box">
              <input type="text" id="serviceSearch" placeholder="Search services...">
              <i class="fas fa-search"></i>
            </div>
            <button id="addServiceBtn" class="btn btn-primary">
              <i class="fas fa-plus"></i> Add Service
            </button>
          </div>
          <div class="table-responsive">
            <table id="servicesTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Rate</th>
                  <th>Min-Max</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Services will be loaded here -->
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <button id="prevServicePage" class="btn btn-outline" disabled>Previous</button>
            <span id="servicePageInfo">Page 1 of 1</span>
            <button id="nextServicePage" class="btn btn-outline" disabled>Next</button>
          </div>
        </div>

        <!-- Orders Management Tab -->
        <div id="orders-tab" class="tab-pane">
          <div class="table-actions">
            <div class="filter-group">
              <label>Status:</label>
              <select id="adminStatusFilter">
                <option value="">All Statuses</option>
                <option value="processing">Processing</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
                <option value="partial">Partially Completed</option>
              </select>
            </div>
            <div class="search-box">
              <input type="text" id="adminOrderSearch" placeholder="Search orders...">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="table-responsive">
            <table id="adminOrdersTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>User</th>
                  <th>Service</th>
                  <th>Link</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Orders will be loaded here -->
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <button id="prevAdminOrderPage" class="btn btn-outline" disabled>Previous</button>
            <span id="adminOrderPageInfo">Page 1 of 1</span>
            <button id="nextAdminOrderPage" class="btn btn-outline" disabled>Next</button>
          </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions-tab" class="tab-pane">
          <div class="table-actions">
            <div class="filter-group">
              <label>Type:</label>
              <select id="transactionTypeFilter">
                <option value="">All Types</option>
                <option value="deposit">Deposit</option>
                <option value="order">Order</option>
                <option value="refund">Refund</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Date Range:</label>
              <input type="date" id="transactionStartDate">
              <span>to</span>
              <input type="date" id="transactionEndDate">
            </div>
            <button id="applyTransactionFilter" class="btn btn-primary">Apply</button>
          </div>
          <div class="table-responsive">
            <table id="transactionsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>User</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Order ID</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <!-- Transactions will be loaded here -->
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <button id="prevTransactionPage" class="btn btn-outline" disabled>Previous</button>
            <span id="transactionPageInfo">Page 1 of 1</span>
            <button id="nextTransactionPage" class="btn btn-outline" disabled>Next</button>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-pane">
          <div class="settings-form">
            <h4>Panel Settings</h4>
            <form id="panelSettingsForm">
              <div class="form-group">
                <label>Panel Name</label>
                <input type="text" id="panelName" required>
              </div>
              <div class="form-group">
                <label>Maintenance Mode</label>
                <select id="maintenanceMode" required>
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
              </div>
              <div class="form-group">
                <label>Minimum Deposit Amount</label>
                <input type="number" id="minDeposit" min="1" step="0.01" required>
              </div>
              <div class="form-group">
                <label>Currency</label>
                <input type="text" id="currency" required>
              </div>
              <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Add New User</h3>
      <form id="addUserForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="userEmail" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="userPassword" minlength="6" required>
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="userNameInput">
        </div>
        <div class="form-group">
          <label>Initial Balance</label>
          <input type="number" id="userBalance" min="0" step="0.01" value="0">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="userRole" required>
            <option value="user">User</option>
            <option value="reseller">Reseller</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Create User</button>
      </form>
    </div>
  </div>

  <!-- Add Service Modal -->
  <div id="addServiceModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Add New Service</h3>
      <form id="addServiceForm">
        <div class="form-group">
          <label>Service Name</label>
          <input type="text" id="serviceName" required>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="serviceCategory" required>
            <option value="instagram">Instagram</option>
            <option value="youtube">YouTube</option>
            <option value="twitter">Twitter</option>
            <option value="facebook">Facebook</option>
            <option value="tiktok">TikTok</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="serviceDescription" rows="3" required></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Rate per 1000</label>
            <input type="number" id="serviceRate" min="0.01" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Min Quantity</label>
            <input type="number" id="serviceMin" min="1" required>
          </div>
          <div class="form-group">
            <label>Max Quantity</label>
            <input type="number" id="serviceMax" min="1" required>
          </div>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="serviceStatus" required>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Add Service</button>
      </form>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="editOrderModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Update Order</h3>
      <form id="editOrderForm">
        <input type="hidden" id="editOrderId">
        <div class="form-group">
          <label>Status</label>
          <select id="editOrderStatus" required>
            <option value="processing">Processing</option>
            <option value="completed">Completed</option>
            <option value="partial">Partially Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label>Delivered Quantity</label>
          <input type="number" id="editOrderDelivered" min="0">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="editOrderNotes" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Update Order</button>
      </form>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { db, auth, functions } from './js/firebase.js';
    import { checkAdminStatus, formatCurrency, formatDate } from './js/main.js';
    
    // Authentication check
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = 'auth.html';
      } else {
        // Verify admin status
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists || userDoc.data().role !== 'admin') {
          window.location.href = 'index.html';
          return;
        }
        
        document.getElementById('userName').textContent = user.displayName || user.email;
        if (user.photoURL) {
          document.getElementById('userAvatar').src = user.photoURL;
        }
        
        // Load admin dashboard data
        loadAdminStats();
        setupCharts();
        
        // Tab switching
        setupTabs();
        
        // Load initial tab content
        loadUsers();
      }
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = 'auth.html';
      });
    });

    // Load admin statistics
    async function loadAdminStats() {
      try {
        // Total users
        const usersCount = await db.collection('users').count().get();
        document.getElementById('totalUsers').textContent = usersCount.data().count;
        
        // Active services
        const servicesCount = await db.collection('services')
          .where('status', '==', 'active')
          .count()
          .get();
        document.getElementById('totalServices').textContent = servicesCount.data().count;
        
        // Today's orders
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const ordersCount = await db.collection('orders')
          .where('createdAt', '>=', today)
          .count()
          .get();
        document.getElementById('totalOrders').textContent = ordersCount.data().count;
        
        // Today's revenue
        const ordersSnapshot = await db.collection('orders')
          .where('createdAt', '>=', today)
          .get();
        
        let totalRevenue = 0;
        ordersSnapshot.forEach(doc => {
          totalRevenue += doc.data().price;
        });
        
        document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
      } catch (error) {
        console.error("Error loading admin stats:", error);
      }
    }

    // Setup charts
    function setupCharts() {
      // Orders chart
      const ordersCtx = document.getElementById('ordersChart').getContext('2d');
      const ordersChart = new Chart(ordersCtx, {
        type: 'line',
        data: {
          labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
          datasets: [{
            label: 'Orders',
            data: [12, 19, 3, 5, 2, 3, 15],
            backgroundColor: 'rgba(67, 97, 238, 0.2)',
            borderColor: 'rgba(67, 97, 238, 1)',
            borderWidth: 2,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Revenue chart
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  const revenueChart = new Chart(revenueCtx, {
    type: 'bar',
    data: {
      labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
      datasets: [{
        label: 'Revenue',
        data: [50, 75, 30, 45, 20, 35, 90],
        backgroundColor: 'rgba(76, 201, 240, 0.7)',
        borderColor: 'rgba(76, 201, 240, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Load actual data for charts
  loadChartData(ordersChart, revenueChart);
}

// Load actual data for charts
async function loadChartData(ordersChart, revenueChart) {
  try {
    // Get dates for last 7 days
    const dates = [];
    const dateLabels = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      date.setHours(0, 0, 0, 0);
      dates.push(date);
      dateLabels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
    }

    // Update chart labels
    ordersChart.data.labels = dateLabels;
    revenueChart.data.labels = dateLabels;

    // Get orders and revenue for each day
    const ordersData = [];
    const revenueData = [];

    for (const date of dates) {
      const nextDay = new Date(date);
      nextDay.setDate(nextDay.getDate() + 1);

      // Get orders count for the day
      const ordersCount = await db.collection('orders')
        .where('createdAt', '>=', date)
        .where('createdAt', '<', nextDay)
        .count()
        .get();
      ordersData.push(ordersCount.data().count);

      // Get total revenue for the day
      const ordersSnapshot = await db.collection('orders')
        .where('createdAt', '>=', date)
        .where('createdAt', '<', nextDay)
        .get();
      
      let dailyRevenue = 0;
      ordersSnapshot.forEach(doc => {
        dailyRevenue += doc.data().price;
      });
      revenueData.push(dailyRevenue);
    }

    // Update chart data
    ordersChart.data.datasets[0].data = ordersData;
    revenueChart.data.datasets[0].data = revenueData;
    ordersChart.update();
    revenueChart.update();
  } catch (error) {
    console.error("Error loading chart data:", error);
  }
}

// Tab switching functionality
function setupTabs() {
  const tabs = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remove active class from all tabs and panes
      tabs.forEach(t => t.classList.remove('active'));
      tabPanes.forEach(pane => pane.classList.remove('active'));

      // Add active class to clicked tab and corresponding pane
      tab.classList.add('active');
      const tabId = tab.dataset.tab;
      document.getElementById(`${tabId}-tab`).classList.add('active');

      // Load content for the selected tab
      switch(tabId) {
        case 'dashboard':
          loadAdminStats();
          break;
        case 'users':
          loadUsers();
          break;
        case 'services':
          loadServices();
          break;
        case 'orders':
          loadAdminOrders();
          break;
        case 'transactions':
          loadTransactions();
          break;
        case 'settings':
          loadSettings();
          break;
      }
    });
  });
}

// Users management
let usersLastVisible = null;
let usersFirstVisible = null;
let currentUsersPage = 1;
const usersPerPage = 10;

async function loadUsers() {
  const usersTable = document.querySelector('#usersTable tbody');
  usersTable.innerHTML = '<tr><td colspan="8" class="loading">Loading users...</td></tr>';

  try {
    let query = db.collection('users')
      .orderBy('createdAt', 'desc')
      .limit(usersPerPage);

    if (usersLastVisible && currentUsersPage > 1) {
      query = query.startAfter(usersLastVisible);
    }

    const snapshot = await query.get();

    if (snapshot.empty) {
      usersTable.innerHTML = '<tr><td colspan="8" class="no-data">No users found</td></tr>';
      return;
    }

    // Update pagination markers
    usersLastVisible = snapshot.docs[snapshot.docs.length - 1];
    usersFirstVisible = snapshot.docs[0];

    // Get total count
    const totalCount = await db.collection('users').count().get();
    const totalPages = Math.ceil(totalCount.data().count / usersPerPage);

    // Update pagination controls
    document.getElementById('userPageInfo').textContent = `Page ${currentUsersPage} of ${totalPages}`;
    document.getElementById('prevUserPage').disabled = currentUsersPage <= 1;
    document.getElementById('nextUserPage').disabled = currentUsersPage >= totalPages;

    // Render users
    usersTable.innerHTML = '';
    snapshot.forEach(doc => {
      const user = doc.data();
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>${doc.id.substring(0, 8)}...</td>
        <td>${user.email || 'N/A'}</td>
        <td>${user.displayName || 'N/A'}</td>
        <td>${formatCurrency(user.balance || 0)}</td>
        <td><span class="badge ${user.role}">${user.role}</span></td>
        <td>${formatDate(user.createdAt)}</td>
        <td><span class="status active">Active</span></td>
        <td>
          <button class="btn-edit" data-id="${doc.id}">Edit</button>
          <button class="btn-delete" data-id="${doc.id}">Delete</button>
        </td>
      `;
      
      usersTable.appendChild(row);
    });

    // Add event listeners to buttons
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', () => editUser(btn.dataset.id));
    });

    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => deleteUser(btn.dataset.id));
    });

  } catch (error) {
    console.error("Error loading users:", error);
    usersTable.innerHTML = '<tr><td colspan="8" class="error">Failed to load users</td></tr>';
  }
}

// Add user modal
document.getElementById('addUserBtn').addEventListener('click', () => {
  document.getElementById('addUserModal').style.display = 'block';
});

// Add user form submission
document.getElementById('addUserForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('userEmail').value;
  const password = document.getElementById('userPassword').value;
  const name = document.getElementById('userNameInput').value;
  const balance = parseFloat(document.getElementById('userBalance').value) || 0;
  const role = document.getElementById('userRole').value;

  try {
    // Create user with Firebase Auth
    const { user } = await auth.createUserWithEmailAndPassword(email, password);
    
    // Set display name if provided
    if (name) {
      await user.updateProfile({
        displayName: name
      });
    }

    // Create user document in Firestore
    await db.collection('users').doc(user.uid).set({
      email: email,
      displayName: name || '',
      balance: balance,
      role: role,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Add transaction record if balance > 0
    if (balance > 0) {
      await db.collection('transactions').add({
        userId: user.uid,
        amount: balance,
        type: 'deposit',
        status: 'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        notes: 'Initial balance'
      });
    }

    alert('User created successfully!');
    document.getElementById('addUserModal').style.display = 'none';
    document.getElementById('addUserForm').reset();
    loadUsers();
  } catch (error) {
    console.error("Error creating user:", error);
    alert(`Failed to create user: ${error.message}`);
  }
});

// Edit user function
async function editUser(userId) {
  // Implementation for editing user
  alert(`Edit user with ID: ${userId}`);
}

// Delete user function
async function deleteUser(userId) {
  if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
  
  try {
    // Delete user from Authentication
    await auth.deleteUser(userId);
    
    // Delete user document from Firestore
    await db.collection('users').doc(userId).delete();
    
    alert('User deleted successfully');
    loadUsers();
  } catch (error) {
    console.error("Error deleting user:", error);
    alert(`Failed to delete user: ${error.message}`);
  }
}

// Users pagination
document.getElementById('prevUserPage').addEventListener('click', () => {
  if (currentUsersPage > 1) {
    currentUsersPage--;
    loadUsers();
  }
});

document.getElementById('nextUserPage').addEventListener('click', () => {
  currentUsersPage++;
  loadUsers();
});

// Modal close handlers
document.querySelectorAll('.modal .close').forEach(closeBtn => {
  closeBtn.addEventListener('click', () => {
    closeBtn.closest('.modal').style.display = 'none';
  });
});

window.addEventListener('click', (event) => {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
});

// Services management
async function loadServices() {
  const servicesTable = document.querySelector('#servicesTable tbody');
  servicesTable.innerHTML = '<tr><td colspan="7" class="loading">Loading services...</td></tr>';

  try {
    const snapshot = await db.collection('services').get();

    if (snapshot.empty) {
      servicesTable.innerHTML = '<tr><td colspan="7" class="no-data">No services found</td></tr>';
      return;
    }

    servicesTable.innerHTML = '';
    snapshot.forEach(doc => {
      const service = doc.data();
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>${doc.id.substring(0, 8)}...</td>
        <td>${service.name}</td>
        <td>${service.category}</td>
        <td>${formatCurrency(service.rate)}</td>
        <td>${service.min}-${service.max}</td>
        <td><span class="status ${service.status}">${service.status}</span></td>
        <td>
          <button class="btn-edit" data-id="${doc.id}">Edit</button>
          <button class="btn-delete" data-id="${doc.id}">Delete</button>
        </td>
      `;
      
      servicesTable.appendChild(row);
    });

    // Add event listeners to buttons
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', () => editService(btn.dataset.id));
    });

    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => deleteService(btn.dataset.id));
    });

  } catch (error) {
    console.error("Error loading services:", error);
    servicesTable.innerHTML = '<tr><td colspan="7" class="error">Failed to load services</td></tr>';
  }
}

// Add service modal
document.getElementById('addServiceBtn').addEventListener('click', () => {
  document.getElementById('addServiceModal').style.display = 'block';
});

// Add service form submission
document.getElementById('addServiceForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const serviceData = {
    name: document.getElementById('serviceName').value,
    category: document.getElementById('serviceCategory').value,
    description: document.getElementById('serviceDescription').value,
    rate: parseFloat(document.getElementById('serviceRate').value),
    min: parseInt(document.getElementById('serviceMin').value),
    max: parseInt(document.getElementById('serviceMax').value),
    status: document.getElementById('serviceStatus').value,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    await db.collection('services').add(serviceData);
    
    alert('Service added successfully!');
    document.getElementById('addServiceModal').style.display = 'none';
    document.getElementById('addServiceForm').reset();
    loadServices();
  } catch (error) {
    console.error("Error adding service:", error);
    alert(`Failed to add service: ${error.message}`);
  }
});

// Edit service function
async function editService(serviceId) {
  // Implementation for editing service
  alert(`Edit service with ID: ${serviceId}`);
}

// Delete service function
async function deleteService(serviceId) {
  if (!confirm('Are you sure you want to delete this service? This action cannot be undone.')) return;
  
  try {
    await db.collection('services').doc(serviceId).delete();
    alert('Service deleted successfully');
    loadServices();
  } catch (error) {
    console.error("Error deleting service:", error);
    alert(`Failed to delete service: ${error.message}`);
  }
}

// Orders management
async function loadAdminOrders() {
  const ordersTable = document.querySelector('#adminOrdersTable tbody');
  ordersTable.innerHTML = '<tr><td colspan="9" class="loading">Loading orders...</td></tr>';

  try {
    const snapshot = await db.collection('orders')
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get();

    if (snapshot.empty) {
      ordersTable.innerHTML = '<tr><td colspan="9" class="no-data">No orders found</td></tr>';
      return;
    }

    ordersTable.innerHTML = '';
    snapshot.forEach(async doc => {
      const order = doc.data();
      
      // Get user email
      let userEmail = 'N/A';
      try {
        const userDoc = await db.collection('users').doc(order.userId).get();
        if (userDoc.exists) {
          userEmail = userDoc.data().email;
        }
      } catch (error) {
        console.error("Error fetching user:", error);
      }

      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>${doc.id.substring(0, 8)}...</td>
        <td>${userEmail}</td>
        <td>${order.serviceName}</td>
        <td class="truncate">${order.link || 'N/A'}</td>
        <td>${order.quantity}</td>
        <td>${formatCurrency(order.price)}</td>
        <td><span class="status ${order.status}">${order.status}</span></td>
        <td>${formatDate(order.createdAt)}</td>
        <td>
          <button class="btn-edit" data-id="${doc.id}">Update</button>
        </td>
      `;
      
      ordersTable.appendChild(row);
    });

    // Add event listeners to edit buttons
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', () => openEditOrderModal(btn.dataset.id));
    });

  } catch (error) {
    console.error("Error loading orders:", error);
    ordersTable.innerHTML = '<tr><td colspan="9" class="error">Failed to load orders</td></tr>';
  }
}

// Open edit order modal
async function openEditOrderModal(orderId) {
  const modal = document.getElementById('editOrderModal');
  const orderDoc = await db.collection('orders').doc(orderId).get();
  
  if (!orderDoc.exists) {
    alert('Order not found');
    return;
  }

  const order = orderDoc.data();
  document.getElementById('editOrderId').value = orderId;
  document.getElementById('editOrderStatus').value = order.status;
  document.getElementById('editOrderDelivered').value = order.deliveredQuantity || '';
  document.getElementById('editOrderNotes').value = order.notes || '';
  
  modal.style.display = 'block';
}

// Edit order form submission
document.getElementById('editOrderForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const orderId = document.getElementById('editOrderId').value;
  const status = document.getElementById('editOrderStatus').value;
  const deliveredQuantity = document.getElementById('editOrderDelivered').value;
  const notes = document.getElementById('editOrderNotes').value;

  const updateData = {
    status: status,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (deliveredQuantity) {
    updateData.deliveredQuantity = parseInt(deliveredQuantity);
  }

  if (notes) {
    updateData.notes = notes;
  }

  try {
    await db.collection('orders').doc(orderId).update(updateData);
    
    alert('Order updated successfully!');
    document.getElementById('editOrderModal').style.display = 'none';
    loadAdminOrders();
  } catch (error) {
    console.error("Error updating order:", error);
    alert(`Failed to update order: ${error.message}`);
  }
});

// Transactions management
async function loadTransactions() {
  const transactionsTable = document.querySelector('#transactionsTable tbody');
  transactionsTable.innerHTML = '<tr><td colspan="7" class="loading">Loading transactions...</td></tr>';

  try {
    const snapshot = await db.collection('transactions')
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get();

    if (snapshot.empty) {
      transactionsTable.innerHTML = '<tr><td colspan="7" class="no-data">No transactions found</td></tr>';
      return;
    }

    transactionsTable.innerHTML = '';
    snapshot.forEach(async doc => {
      const transaction = doc.data();
      
      // Get user email
      let userEmail = 'N/A';
      try {
        const userDoc = await db.collection('users').doc(transaction.userId).get();
        if (userDoc.exists) {
          userEmail = userDoc.data().email;
        }
      } catch (error) {
        console.error("Error fetching user:", error);
      }

      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>${doc.id.substring(0, 8)}...</td>
        <td>${userEmail}</td>
        <td>${transaction.type}</td>
        <td class="${transaction.type === 'deposit' ? 'text-success' : 'text-danger'}">
          ${transaction.type === 'deposit' ? '+' : '-'}${formatCurrency(transaction.amount)}
        </td>
        <td>${transaction.orderId ? transaction.orderId.substring(0, 8) + '...' : 'N/A'}</td>
        <td><span class="status ${transaction.status}">${transaction.status}</span></td>
        <td>${formatDate(transaction.createdAt)}</td>
      `;
      
      transactionsTable.appendChild(row);
    });

  } catch (error) {
    console.error("Error loading transactions:", error);
    transactionsTable.innerHTML = '<tr><td colspan="7" class="error">Failed to load transactions</td></tr>';
  }
}

// Load panel settings
async function loadSettings() {
  try {
    const doc = await db.collection('panelSettings').doc('main').get();
    
    if (doc.exists) {
      const settings = doc.data();
      document.getElementById('panelName').value = settings.panelName || '';
      document.getElementById('maintenanceMode').value = settings.maintenanceMode ? 'true' : 'false';
      document.getElementById('minDeposit').value = settings.minDeposit || 5;
      document.getElementById('currency').value = settings.currency || 'USD';
    }
  } catch (error) {
    console.error("Error loading settings:", error);
  }
}

// Save panel settings
document.getElementById('panelSettingsForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const settings = {
    panelName: document.getElementById('panelName').value,
    maintenanceMode: document.getElementById('maintenanceMode').value === 'true',
    minDeposit: parseFloat(document.getElementById('minDeposit').value),
    currency: document.getElementById('currency').value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    await db.collection('panelSettings').doc('main').set(settings, { merge: true });
    alert('Settings saved successfully!');
  } catch (error) {
    console.error("Error saving settings:", error);
    alert(`Failed to save settings: ${error.message}`);
  }
});
      </script>
</body>
</html>
